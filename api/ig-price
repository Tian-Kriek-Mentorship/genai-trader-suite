// /api/ig-price.js

export default async function handler(req, res) {
  const IG_API_KEY = process.env.IG_API_KEY;
  const IG_USERNAME = process.env.IG_USERNAME;
  const IG_PASSWORD = process.env.IG_PASSWORD;
  const IG_ACCOUNT_TYPE = process.env.IG_ACCOUNT_TYPE || "LIVE";

  const { epic = "CS.D.BITCOIN.CFD.IP", resolution = "DAY", max = 365 } = req.query;

  const loginUrl = "https://api.ig.com/gateway/deal/session";
  const pricesUrl = `https://api.ig.com/gateway/deal/prices/${epic}?resolution=${resolution}&max=${max}`;

  try {
    // Step 1: Login to IG
    const loginRes = await fetch(loginUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "X-IG-API-KEY": IG_API_KEY,
        "Version": "2"
      },
      body: JSON.stringify({
        identifier: IG_USERNAME,
        password: IG_PASSWORD,
      }),
    });

    if (!loginRes.ok) {
      return res.status(loginRes.status).json({ error: "IG login failed" });
    }

    const cst = loginRes.headers.get("CST");
    const xSecurityToken = loginRes.headers.get("X-SECURITY-TOKEN");

    if (!cst || !xSecurityToken) {
      return res.status(401).json({ error: "Missing tokens from IG login" });
    }

    // Step 2: Fetch OHLC data
    const pricesRes = await fetch(pricesUrl, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "X-IG-API-KEY": IG_API_KEY,
        CST: cst,
        "X-SECURITY-TOKEN": xSecurityToken,
      },
    });

    if (!pricesRes.ok) {
      return res.status(pricesRes.status).json({ error: "IG price fetch failed" });
    }

    const pricesData = await pricesRes.json();

    const candles = pricesData.prices
      .filter(p => p.closePrice?.bid)
      .map(p => ({
        time: Math.floor(new Date(p.snapshotTimeUTC).getTime() / 1000),
        open: p.openPrice.bid,
        high: p.highPrice.bid,
        low: p.lowPrice.bid,
        close: p.closePrice.bid,
      }));

    return res.status(200).json({ candles });
  } catch (err) {
    console.error("IG API error:", err);
    return res.status(500).json({ error: "Internal server error" });
  }
}
